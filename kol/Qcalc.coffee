
# ACtual data for make friends
cellar_mon = [1,1]
cellar_stream = [0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,1,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,1,0,1,0,0,0,0,0,1,0,0,1,0,0,1,1,1,1,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,1,0,1,0,1,0,0,0,0,0,1,0,1,0,0,1,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,1,0,0,1,0,1,0,0,0,0,0,0,1,1,0,0,1,0,1,0,1]

# Actual data from olfaction in 3 monster zone
dairy_stream =[0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 2, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2]


#data from non-olfacted case
rat_stream = [0, 0, 1, 1, 0, 1, 1, 0, 1,0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0]

#data from making friends in the 8bit 
bit_mon  = [1, 1, 1, 1, 1, 1, 1, 1]
bit_stream = [0, 1, 0, 2, 0, 3, 4, 1, 3, 5, 0, 2, 6, 1, 2, 5, 3, 5, 4, 0, 5, 7, 6, 0, 7, 7, 5, 0, 6, 0, 4, 0, 4, 0, 1, 6, 4, 7, 0, 0, 1, 5, 6, 0, 6, 6, 3, 7, 0, 0, 7, 0, 3, 3, 5, 2, 6, 0, 1, 4, 0, 2, 0, 6, 2, 1, 3, 0, 4, 6, 0, 0, 1, 4, 5, 2, 1, 3, 0, 2, 6, 5, 0, 7, 0, 3, 6, 4, 0, 2, 5, 2, 7, 6, 1, 0, 3, 4, 0, 0, 0, 6, 0, 2, 2, 1, 4, 3, 1, 0, 5, 5, 2, 6, 0, 3, 0, 4, 0, 1, 0, 5, 6, 4, 2, 1, 7, 5, 7, 0, 3, 0, 2, 4, 5, 7, 1, 0, 3, 6, 4, 2, 4, 3, 7, 0, 6, 2]

#Data from making friends with entryway bats
entry_mon = [1,1,1]
entry_stream = [0,0,1,2,0,0,1,0,1,0,2,0,2,1,0,0,2,0,2,0,1,0,1,2,1,0,1,0,1,2,0,2,1,1,0,0,0,2,0,0,1,2,0,0,0,1,1,0,1,0,2,0,2,0,0,0,1,0,0,0,1,2,2,2,0,0,0,0,0,1,0,2,2,0,1,0,2,0,0,0,0,2,0,1,1,0,0,0,0,2,0,1,0,0,0,0,0,2,1,0,0,0,0,0,2,0,0,0,0,1,0,0,2,0,2,1,0,0,0,2,0,1,0,0,1,2,0,2,0,0,1,2,0,2,0,0,2,1,0,0,1,0,2,0,0,0,0,0,0,2,2,0,1,0,0,1,1,2,1,0,1,1,0,0,0,2,1,0,1,0,0,2,0,1]

#Data from making friends in the haunted kitchen
kitch_mon = [1, 1, 1, 1, 1]
kitch_stream = [0,0,1,0,2,3,4,0,3,2,1,0,4,0,3,3,1,2,0,3,0,4,0,2,0,0,0,0,1,0,0,2,1,0,0,4,3,0,3,1,0,4,4,0,3,1,3,2,0,4,0,4,3,4,2,1,0,3,0,3,0,4,3,1,3,3,0,2,0,4,1,3,0,1,0,2,0,3,4,4,4,2,0,3,0,1,4,2,1,0,3,0,2,4,3,0,0,4,2,1,0,3,2]

#Data from heeheehee in ballroom
hee_mon = [1,1,1]
hee_stream = [0,1,0,0,0,2,0,1,2,2,0,0,0,0,1,2,0,0,2,1,0,0,0,0,2,1,0,0,0,0,2,0,0,0,1,0,0,0,0,2,1,2,1,0,1,0,0,2,2,2,0,0,1,0,0,2,0,0,0,1,0,2,0,0,1,0,2,0,0,2,0,1,2,0,0,0,2,1,0,0,0,0,0,2,1,0,0,1,2,1,0,0,0,2,0,1,2,2,1,2,0,0,2,1,2,1,0,0,0,1,2,0,2,1,0,0,1,2,0,0,0,0,1,2,0,0,0,0,1,1,2,0,0,0,0,2,1,0,1,0]

streams = [
	{monsters:bit_mon, stream:bit_stream},
	{monsters:cellar_mon, stream:cellar_stream},
	{monsters:entry_mon, stream:entry_stream},
	{monsters:hee_mon, stream:hee_stream},
	{monsters:kitch_mon, stream:kitch_stream}
]

default_submodels = {
	"ignore the queue": 0,
	"normal queue": STANDARD_REJECTION
}

N_max = 20
STANDARD_REJECTION = 3/4


round = (x)-> Math.round(x * 100000)/1000

window.analyze = analyze = ()->
	models = init()

	for data in streams
		processStream(data, models)
	normalize(models)
	output(models)
	
output = (models)->
	out = "N\t\t normal Q\t\t no rej"
	report = []
	for mod in models
		if mod.confidence >= .001
			report.push(mod)
	
	report.sort( (a, b)-> b.confidence - a.confidence)
	report_out = ""
	for mod in report
		report_out += mod.report() + "\n"
	console.log(report_out)
	window.document.getElementById("output").value = report_out

window.runit = ()->
	data = document.getElementById("data").value
	streams = JSON.parse(data)
	analyze()


init = ()->
	models = []

	submodels = default_submodels
	smv = document.getElementById("submodels").value 
	submodels = JSON.parse(smv)
	for n in [0..N_max]
		for name, rejection of submodels
			models.push( new Model(n, rejection, "+#{n} copies, #{name}"))
	return models


normalize = (models)->
	tot = 0;

	#shift by a constant so things don't disappear into the ether aka limited float precision
	max = -Infinity
	for mod in models
		max = Math.max(mod.log_prob, max)
	for mod in models
		tot += mod.confidence = Math.exp(mod.log_prob - max)
	
	for mod in models
		mod.confidence /= tot


processStream = (data, models) ->
	stream = data.stream
	monsters = data.monsters

	for mod in models
		mod.setZone(monsters)
	queue = new Q()

	#Process data, ignoring the first 5 points so that we know the queue for sure!
	for m, i in stream
		if (i>=5)
			mod.processDataPoint(m, queue) for mod in models
		queue.add(m)			


class Q
	constructor: ()->
		@queue = []
	reset: ()->
		@queue = []
	add: (id)->
		@queue.push(id)
		@queue.shift() if @queue.length > 5
	check: (id)->
		for monster in @queue
			if id is monster
				return true
		return false


class Model
	constructor: (N, j_special, description)->
		@N = N
		@rej = []
		@j_special = j_special
		@log_prob = 0
		@description = description

	report: ()-> "#{@con()}% #{@description}"

	con: ()-> Math.round(@confidence * 100000)/1000


	setZone: (monsters)->
		@monsters = monsters
		@rates = []
		e = 0
		for copies in monsters
			e+=copies
		for copies, i in monsters
			if i is 0
				@rates[i] = (copies+@N)/(e+@N)
			else
				@rates[i] = (copies)/(e+@N)

	processDataPoint: (i, queue)->
		@log_prob += Math.log( @p(i, queue) )

	p: (i, queue)->
		r = @rates[i]
		j = @getJ(i, queue)
		rej = @getRej(queue)
		return r * (1 - j)/ (1-rej)

	getJ: (i, queue)->
		if queue.check(i)
			if i is 0 then return @j_special else return STANDARD_REJECTION
		else
			return 0

	getRej: (queue)->
		rej = 0
		for r, m in @rates
			rej+= r * @getJ(m, queue)
		return rej
